C51 COMPILER V9.56.0.0   FLASH                                                             09/26/2018 10:29:50 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE FLASH
OBJECT MODULE PLACED IN .\Flash.obj
COMPILER INVOKED BY: C:\Keil_v5c51\C51\BIN\C51.EXE ..\user\Flash.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRI
                    -NT(.\Flash.lst) OBJECT(.\Flash.obj)

line level    source

   1          /**
   2          *       ************************************************************************************
   3          *                                                                        模块性能介绍
   4          *       1、擦写次数10万次以上
   5          *       2、扇区擦除时间约4.2ms，且擦除时不响应任何中断，但会置相关标志位，擦除完成后响应
   6          *       3、可设置应用程序读保护，应用程序写保护（以1K字节为保护单位）
   7          *       4、可以设置仿真器扇区读保护，扇区写保护（以4K字节为保护单位）
   8          *       5、设置保护后无法擦写程序，读取的数据全为零
   9          *       ************************************************************************************
  10          *                                                                        应用注意事项
  11          *       1、CPU时钟需要配置为1-16MHz之间的正整数，且Flash擦写之前需要配置FREQ_CLK寄存器，该寄
  12          *          存器值即为当前CPU时钟频率。
  13          *       2、扇区擦除写入过程中不能被打断
  14          *       3、数据存放地址需要在程序存放地址之后
  15          *       4、第二复位向量使能时，无法在仿真环境下查看code区数据
  16          *       ************************************************************************************
  17          **/
  18          
  19          #include "HC89F0650.h"
  20          #include "intrins.h"
  21          #include "Flash.h"
  22          
  23          /***************************************************************************************
  24            * @说明       扇区擦除，约消耗4.2ms的时间
  25            * @参数       Address ：被擦除的扇区内的任意一个地址
  26            *                     取值范围：0X0000-0XFFFF
  27            * @返回值 无
  28            * @注         只要操作扇区里面的任意一个地址，就可以擦除此扇区
  29          ***************************************************************************************/
  30          void Flash_EraseBlock(unsigned int Address)
  31          {
  32   1              IAP_CMD  = 0xF00F;      //命令寄存器---解锁
  33   1              IAP_ADDR = Address;     //写入擦除地址
  34   1              IAP_CMD  = 0xD22D;      //选择操作方式， 扇区擦除
  35   1              IAP_CMD  = 0xE11E;      //触发后 IAP_ADDRL&IAP_ADDRH 指向 0xFF，同时自动锁定
  36   1      }
  37          
  38          /***************************************************************************************
  39            * @说明       写入任一个数据到FLASH里面
  40            * @参数       Address ：FLASH起始地址
  41            *                     取值范围：0X0000-0XFFFF
  42            *     @参数   datt：写入的数据
  43            *                     取值范围：0X00-0XFF
  44            * @返回值 无
  45            * @注         写之前必须先对操作的扇区进行擦除
  46          ***************************************************************************************/
  47          void FLASH_ProgramWord(unsigned int Address,unsigned char datt)
  48          {
  49   1              IAP_DATA = datt;                //待编程数据，写入数据寄存器必须放在解锁之前
  50   1              IAP_CMD  = 0xF00F;              //命令寄存器---解锁
  51   1              IAP_ADDR = Address;         //地址寄存器---写地址
  52   1              IAP_CMD  = 0xB44B;              //命令寄存器---字节编程
  53   1              IAP_CMD  = 0xE11E;              //命令寄存器---触发一次
  54   1      }
C51 COMPILER V9.56.0.0   FLASH                                                             09/26/2018 10:29:50 PAGE 2   

  55          
  56          /***************************************************************************************
  57            * @说明       软件复位重读OPTION
  58            * @参数       无
  59            * @返回值 无
  60            * @注         在16K的ROM之外有一个只读的OPTION区域，存放的内容包括：用户定义的一些数据、用
  61            *                     户设置的密码、芯片的一些配置、第二复位向量相关的内容
  62          ***************************************************************************************/
  63          void Flash_RestWithReadOption(void)
  64          {
  65   1              IAP_CMD = 0xF00F;               //命令寄存器---解锁
  66   1              IAP_CMD = 0x7887;               //命令寄存器---重读代码选项
  67   1      }
  68          
  69          /***************************************************************************************
  70            * @说明       软件复位不重读OPTION
  71            * @参数       无
  72            * @返回值 无
  73            * @注         在16K的ROM之外有一个只读的OPTION区域，存放的内容包括：用户定义的一些数据、用
  74            *                     户设置的密码、芯片的一些配置、第二复位向量相关的内容
  75          ***************************************************************************************/
  76          void Flash_RestWithoutReadOption(void)
  77          {
  78   1              IAP_CMD = 0xF00F;               //命令寄存器---解锁
  79   1              IAP_CMD = 0x8778;               //命令寄存器---重读代码选项
  80   1      }
  81          
  82          /***************************************************************************************
  83            * @说明       从FLASH里面读取任意长度的数据
  84            * @参数       Address ：FLASH起始地址
  85            *                     取值范围：0X0000-0XFFFF
  86            *     @参数   Length ： 读取数据长度
  87            *                     取值范围：0X00-0XFF
  88            *     @参数   *SaveArr：读取数据存放的区域首地址
  89            * @返回值 无
  90            * @注         无
  91          ***************************************************************************************/
  92          void Flash_ReadArr(unsigned int Address,unsigned char Length,unsigned char *SaveArr)
  93          {
  94   1              while(Length--)
  95   1                      *(SaveArr++) = *((unsigned char code *)(Address++));
  96   1      }
  97          
  98          /***************************************************************************************
  99            * @说明       计算当前地址的扇区首地址
 100            * @参数       Address ：FLASH当前地址
 101            *                     取值范围：0X0000-0XFFFF
 102            * @返回值 扇区首地址
 103            * @注         无
 104          ***************************************************************************************/
 105          unsigned int Flash_HeadArr(unsigned int Address)
 106          {
 107   1              return Address&(~0x7f);
 108   1      }
 109          
 110          /***************************************************************************************
 111            * @实现效果   在地址0x3C00写入数据0x55后读取出来存放置read[0] 
 112          ***************************************************************************************/                
 113          void Flash_Init(void)   
 114          {
 115   1              FREQ_CLK = 0x08;                                        //扇区读写时钟初始化，FREQ_CLK值即为当前CPU频率
 116   1      }
C51 COMPILER V9.56.0.0   FLASH                                                             09/26/2018 10:29:50 PAGE 3   

 117          
 118          void Flash_Test(void)
 119          {
 120   1              unsigned char read[1] = {0};                                                    //用于存放从Flash中读取的数据
 121   1      
 122   1              Flash_EraseBlock(0x3C00);                       //擦除地址0x3C00所在扇区
 123   1              FLASH_ProgramWord(0x3C00, 0x66);                //在地址0x3C00写入数据0x66
 124   1              Flash_ReadArr(0x3C00, 1, read);         //读取地址0x3C00的数据并存放置read[0]
 125   1              
 126   1              _nop_();
 127   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    194    ----
   CONSTANT SIZE    =      1    ----
   XDATA SIZE       =   ----       6
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
